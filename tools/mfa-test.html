<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MFA Test - GCC Restore</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #00ff00;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            background: rgba(0, 20, 0, 0.8);
            border: 1px solid #00ff00;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        button {
            background: rgba(0, 40, 0, 0.8);
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background: rgba(0, 60, 0, 0.9);
        }
        input {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 8px;
            margin: 5px;
            border-radius: 3px;
        }
        .code {
            font-size: 1.5em;
            font-weight: bold;
            color: #00ffff;
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
            margin: 10px 0;
        }
        .info {
            color: #cccccc;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <h1>üîê MFA Test Console</h1>
    <p class="info">This page helps test the MFA functionality for operator authentication.</p>

    <div class="test-section">
        <h3>üì± TOTP Code Generation</h3>
        <p class="info">Current time-based codes for each operator:</p>
        <div id="totp-codes"></div>
        <button onclick="refreshTOTPCodes()">üîÑ Refresh TOTP Codes</button>
    </div>

    <div class="test-section">
        <h3>üìß Email Code Simulation</h3>
        <select id="operator-select">
            <option value="gcc2024">gcc2024</option>
            <option value="operator123">operator123</option>
            <option value="admin2024">admin2024</option>
            <option value="restore_admin">restore_admin</option>
            <option value="conference_admin">conference_admin</option>
            <option value="itav_operator">itav_operator</option>
        </select>
        <button onclick="simulateEmailCode()">üìß Generate Email Code</button>
        <div id="email-result"></div>
    </div>

    <div class="test-section">
        <h3>üß™ Code Validation Test</h3>
        <input type="text" id="test-code" placeholder="Enter 6-digit code" maxlength="6">
        <button onclick="validateTestCode()">‚úÖ Validate Code</button>
        <div id="validation-result"></div>
    </div>

    <div class="test-section">
        <h3>üîó TOTP Setup URLs</h3>
        <p class="info">QR code URLs for setting up authenticator apps (production use only):</p>
        <div id="setup-urls"></div>
    </div>

    <script src="../src/js/mfa-service.js"></script>
    <script>
        let mfaService;
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            try {
                mfaService = new MFAService();
                console.log('‚úÖ MFA Service initialized');
                
                // Initialize displays
                refreshTOTPCodes();
                generateSetupURLs();
                
                // Auto-refresh TOTP codes every 30 seconds
                setInterval(refreshTOTPCodes, 30000);
            } catch (error) {
                console.error('‚ùå Failed to initialize MFA Service:', error);
                document.getElementById('totp-codes').innerHTML = 
                    '<p style="color: #ff4444;">Failed to initialize MFA Service</p>';
            }
        });
        
        function refreshTOTPCodes() {
            if (!mfaService) {
                console.error('MFA Service not initialized');
                return;
            }
            
            const codesDiv = document.getElementById('totp-codes');
            codesDiv.innerHTML = '';
            
            const operators = ['gcc2024', 'operator123', 'admin2024', 'restore_admin', 'conference_admin', 'itav_operator'];
            
            operators.forEach(operator => {
                try {
                    mfaService.initializeMFA(operator);
                    mfaService.setMFAMethod('totp');
                    const code = mfaService.generateTOTP();
                    
                    const codeDiv = document.createElement('div');
                    codeDiv.innerHTML = `<strong>${operator}:</strong> <span class="code">${code}</span>`;
                    codesDiv.appendChild(codeDiv);
                } catch (error) {
                    console.error('Error generating TOTP for', operator, error);
                    const errorDiv = document.createElement('div');
                    errorDiv.innerHTML = `<strong>${operator}:</strong> <span style="color: #ff4444;">Error</span>`;
                    codesDiv.appendChild(errorDiv);
                }
            });
        }
        
        async function simulateEmailCode() {
            if (!mfaService) {
                document.getElementById('email-result').innerHTML = 
                    '<p style="color: #ff4444;">‚ùå MFA Service not initialized</p>';
                return;
            }
            
            const operator = document.getElementById('operator-select').value;
            const resultDiv = document.getElementById('email-result');
            
            try {
                mfaService.initializeMFA(operator);
                mfaService.setMFAMethod('email');
                const result = await mfaService.sendEmailCode();
                
                resultDiv.innerHTML = `
                    <p>‚úÖ Email sent to: ${result.email}</p>
                    <p>‚è∞ Expires in: ${Math.floor(result.expiresIn / 1000 / 60)} minutes</p>
                    <p class="code">Code: ${mfaService.lastSentCode}</p>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<p style="color: #ff4444;">‚ùå Error: ${error.message}</p>`;
            }
        }
        
        async function validateTestCode() {
            if (!mfaService) {
                document.getElementById('validation-result').innerHTML = 
                    '<p style="color: #ff4444;">‚ùå MFA Service not initialized</p>';
                return;
            }
            
            const code = document.getElementById('test-code').value;
            const resultDiv = document.getElementById('validation-result');
            
            if (!code || code.length !== 6) {
                resultDiv.innerHTML = '<p style="color: #ff4444;">Please enter a 6-digit code</p>';
                return;
            }
            
            try {
                const result = await mfaService.validateCode(code);
                resultDiv.innerHTML = `
                    <p style="color: #44ff44;">‚úÖ Valid code!</p>
                    <p>Operator: ${result.operator}</p>
                    <p>Method: ${result.method}</p>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<p style="color: #ff4444;">‚ùå ${error.message}</p>`;
            }
        }
        
        function generateSetupURLs() {
            if (!mfaService) {
                document.getElementById('setup-urls').innerHTML = 
                    '<p style="color: #ff4444;">‚ùå MFA Service not initialized</p>';
                return;
            }
            
            const urlsDiv = document.getElementById('setup-urls');
            const operators = ['gcc2024', 'operator123', 'admin2024', 'restore_admin', 'conference_admin', 'itav_operator'];
            
            operators.forEach(operator => {
                try {
                    const url = mfaService.getTOTPSetupURL(operator);
                    const urlDiv = document.createElement('div');
                    urlDiv.innerHTML = `
                        <p><strong>${operator}:</strong></p>
                        <p style="font-size: 0.8em; word-break: break-all; color: #888;">${url}</p>
                        <hr style="border-color: #333;">
                    `;
                    urlsDiv.appendChild(urlDiv);
                } catch (error) {
                    console.error('Error generating setup URL for', operator, error);
                    const errorDiv = document.createElement('div');
                    errorDiv.innerHTML = `
                        <p><strong>${operator}:</strong> <span style="color: #ff4444;">Error generating URL</span></p>
                        <hr style="border-color: #333;">
                    `;
                    urlsDiv.appendChild(errorDiv);
                }
            });
        }
        
        // Initialize on page load
        refreshTOTPCodes();
        generateSetupURLs();
        
        // Auto-refresh TOTP codes every 30 seconds
        setInterval(refreshTOTPCodes, 30000);
    </script>
</body>
</html>
